% Copyright 2022 Jeffrey Kegler
% This document is licensed under
% a Creative Commons Attribution-NoDerivs 3.0 United States License.
\documentclass[12pt]{amsart}
\usepackage{url}
\usepackage{placeins}
\usepackage{needspace}

% I just don't care about underfull vbox's
\raggedbottom

\newsavebox{\myBox}
\newlength{\myHt}
\newlength{\myDp}
\newlength{\myWd}
\newcommand{\padBoxC}[3]{%
    \savebox{\myBox}{\ignorespaces#3}%
    \usebox{\myBox}%
    \myHt=\ht\myBox%
    \myDp=\dp\myBox%
    \vrule height\dimexpr\myHt+#1 depth\dimexpr\myDp+#2 width0pt%
}
\newcommand{\padBox}[2]{\padBoxC{#1}{#1}{#2}}

\newcommand{\cellboxWidth}[1]{4.5in}

% non-optional-argument version of cellbox
\newcommand{\cellboxB}[2]{%
    \parbox{#1}{\ignorespaces#2}%
}

% Padded cellbox
\newcommand{\cellbox}[2][\cellboxWidth]{%
    \cellboxB{#1}{%
        \padBoxC{4pt}{0pt}{\vphantom{(}}%
        {\ignorespaces#2}%
        \padBoxC{0pt}{4pt}{\vphantom{(}}%
    }%
}

\begin{document}

\date{\today}

\title{The Aycock-Horspool AHFA: some practical experience}

\author{Jeffrey Kegler}
\thanks{%
Copyright \copyright\ 2023 Jeffrey Kegler.  Version 1.
}
\thanks{%
This document is licensed under
a Creative Commons Attribution-NoDerivs 3.0 United States License.
}

\begin{abstract}
In the course of developing the Marpa parser,
we implemented the
AHFA state-based parsing described in Aycock and Horspool's 2002 paper.
This allowed us to test its effectiveness in practice.
This paper reports our results.
\end{abstract}

\maketitle

\section{ The Aycock-Horspool finite automata. }

Most of the material in this document describes the behavior of
Marpa when it used the states of
the Aycock-Horspool finite automaton.
This material includes statistics, and some carefully worked
out math.
While not relevant to the current version of Marpa,
it may be useful for anyone else wanting to experiment with
the use of LR states in Earley items.

\section{ Statistics on AHFA states. }

\subsection{Confirmed states.}

\begin{table}[ht]
\caption{
  \label{tab:perl-confirmed}
  Confirmed AHFA states for a Perl grammar}
\vspace{1ex}
\begin{tabular}{|r|r|}
\hline
\multicolumn{1}{|c|}
  {\rule{0pt}{2.3ex}
   \rule{0pt}{-.5ex}
   Size}&
  \multicolumn{1}{|c|}{Percent}\\
& \multicolumn{1}{|c|}{of occurrences}\\
\hline
\rule{0pt}{2.3ex}
1&67.05\%\\
2&25.67\%\\
3&2.87\%\\
4&2.68\%\\
5&0.19\%\\
6&0.38\%\\
7&0.19\%\\
8&0.57\%\\
9&0.19\%\\
20&0.19\%\\
\hline
\end{tabular}
\end{table}

We show the counts for the confirmed states for the Perl grammar
in Table \ref{tab:perl-confirmed}
on page \pageref{tab:perl-confirmed}.
They range in size from 1 to 20 items,
but the numbers are heavily skewed toward the low
end.
As can be seen, well over 90\% of the total confirmed states have
just one or two items.
The average size is 1.5235,
and the average of the size squared is 3.9405.

\begin{table}[ht]
\caption{
  \label{tab:html-confirmed}
  Confirmed AHFA states for HTML grammars}
\vspace{1ex}
\begin{tabular}{|r|r|}
\hline
\multicolumn{1}{|c|}
  {\rule{0pt}{2.3ex}
   \rule{0pt}{-.5ex}
   Size}&
  \multicolumn{1}{|c|}{Percent}\\
& \multicolumn{1}{|c|}{of occurrences}\\
\hline
\rule{0pt}{2.3ex}
1&80.96\%\\
2&19.04\%\\
\hline
\end{tabular}
\end{table}

For HTML, I looked at a parser which generates grammars on
the fly, aggregating the states in all of them.
The data are in
Table \ref{tab:html-confirmed}
on page \pageref{tab:html-confirmed}.
The average size is 1.1904,
and the average of the size squared is 1.5712.

\FloatBarrier % Necessary to make 'Needspace' below work
%             % to prevent orphan
\begin{table}[ht]
\caption{
  \label{tab:c-confirmed}
  Confirmed AHFA states for a C grammar}
\vspace{1ex}
\begin{tabular}{|r|r|}
\hline
\multicolumn{1}{|c|}
  {\rule{0pt}{2.3ex}
   \rule{0pt}{-.5ex}
   Size}&
  \multicolumn{1}{|c|}{Occurrences}\\
\hline
\rule{0pt}{2.3ex}
1&695\\
2&188\\
3&40\\
4&17\\
5&6\\
6&8\\
7&6\\
8&4\\
9&1\\
10&2\\
12&2\\
15&1\\
\hline
\end{tabular}
\end{table}

\Needspace{10\baselineskip}% prevent orphan
Table \ref{tab:c-confirmed}
on page \pageref{tab:c-confirmed}
shows the count of confirmed AHFA states, by state size,
for a compiler-quality C grammar,
the confirmed states range in size from 1 to 15 items but again,
the numbers are heavily skewed toward the low
end.  Here are the item counts that appear, with the percent of the total
confirmed AHFA states with that item count in parentheses.
There were 970 confirmed C states.
The average size was 1.52.
The average of the size squared was 3.98.

\subsection{Predicted states.}

The number of predicted states tends to be much more
evenly distributed.
It also tends to be much larger, and
the average for practical grammars may be $O(s)$,
where $s$ is the size of the grammar.
This is the same as the theoretical worst case.

\begin{table}[ht]
\caption{
  \label{tab:perl-predicted}
  Predicted AHFA states for a Perl grammar}
\vspace{1ex}
\begin{tabular}{|l|r|}
\hline
\multicolumn{1}{|c|}
  {\rule{0pt}{2.3ex}
   \rule{0pt}{-.5ex}
   Size of AHFA state}&
  \multicolumn{1}{|c|}{Occurrences of states}\\
   &\multicolumn{1}{|c|}{of that size}\\
\hline
\rule{0pt}{2.3ex}%
2&5\\
\hline
\rule{0pt}{2.3ex}%
3, 142&4\\
\hline
\rule{0pt}{2.3ex}%
1, 4&3\\
\hline
\rule{0pt}{2.3ex}%
6, 7, 143&2\\
\hline
\cellbox[3in]{
  5, 64, 71, 77, 79, 81, 83, 85, 88, 90, 98, 100, 102,
  104, 106, 108, 111, 116, 127, 129, 132, 135, 136, 137, 141,
  144, 149, 151, 156, 157, 220, 224, 225
}
  &1\\
\hline
\end{tabular}
\end{table}

For predicted states, because AHFA states of varied
size are common,
we switch from showing the frequency of AHFA states
for each size,
to showing the sizes of the AHFA state by the
frequency of states of that size.
Table \ref{tab:perl-predicted}
on page \pageref{tab:perl-predicted}
shows the data for a Perl grammar.
The number of predicted states in the Perl grammar was 58.
The average size was 83.59 AHFA items.
The average of the size squared was 11356.41.


\begin{table}[ht]
\caption{
  \label{tab:html-predicted}
  Predicted AHFA states for HTML grammars}
\vspace{1ex}
\begin{tabular}{|r|r|}
\hline
\multicolumn{1}{|c|}
  {\rule{0pt}{2.3ex}
   \rule{0pt}{-.5ex}
   Size}&
  \multicolumn{1}{|c|}{Occurrences}\\
\hline
\rule{0pt}{2.3ex}%
1&95\\
\hline
\rule{0pt}{2.3ex}%
2&95\\
\hline
\rule{0pt}{2.3ex}%
4&95\\
\hline
\rule{0pt}{2.3ex}%
11&181\\
\hline
\rule{0pt}{2.3ex}%
14&181\\
\hline
\rule{0pt}{2.3ex}%
15&294\\
\hline
\rule{0pt}{2.3ex}%
16&112\\
\hline
\rule{0pt}{2.3ex}%
18&349\\
\hline
\rule{0pt}{2.3ex}%
19&120\\
\hline
\rule{0pt}{2.3ex}%
20&190\\
\hline
\rule{0pt}{2.3ex}%
21&63\\
\hline
\rule{0pt}{2.3ex}%
22&22\\
\hline
\rule{0pt}{2.3ex}%
24&8\\
\hline
\rule{0pt}{2.3ex}%
25&16\\
\hline
\rule{0pt}{2.3ex}%
26&16\\
\hline
\rule{0pt}{2.3ex}%
28&2\\
\hline
\rule{0pt}{2.3ex}%
29&16\\
\hline
\end{tabular}
\end{table}

\begin{table}[ht]
\caption{
  \label{tab:c-predicted}
  Predicted AHFA states for a C grammar}
\vspace{1ex}
\begin{tabular}{|l|r|}
\hline
\multicolumn{1}{|c|}
  {\rule{0pt}{2.3ex}
   \rule{0pt}{-.5ex}
   Size of AHFA state}&
  \multicolumn{1}{|c|}{Occurrences of states}\\
   &\multicolumn{1}{|c|}{of that size}\\
\hline
\rule{0pt}{2.3ex}%
2, 3&6\\
\hline
\rule{0pt}{2.3ex}%
8&5\\
\hline
\rule{0pt}{2.3ex}%
4, 90&4\\
\hline
\rule{0pt}{2.3ex}%
6, 11, 31, 47&3\\
\hline
\rule{0pt}{2.3ex}%
\cellbox[3in]{5, 14, 42, 64, 68, 78, 91, 95, 98}
&2\\
\hline
\cellbox[3in]{
1, 7, 9, 12, 15, 17, 18, 19, 21, 22, 25, 28, 29, 33, 34, 36,
37, 40, 43, 44, 45, 46, 52, 53, 54, 57, 58, 61, 65, 66, 69, 72,
74, 76, 80, 81, 86, 87, 89, 94, 96, 97, 99, 102, 105, 108,
115, 117, 119, 123, 125, 127, 144, 149, 150, 154, 181, 219,
222.
}
  &1\\
\hline
\end{tabular}
\end{table}

The data for predicted states in a C grammar
is Table \ref{tab:c-predicted}
on page \pageref{tab:c-predicted}
The number of predicted states in the C grammar was 114.
The average size was 54.81.
The average size squared was 5361.28.
The sizes of the predicted states for the C grammar were spread from 1
to 222.

\subsection{Completed LHS symbols per AHFA state. }
An AHFA state may contain completions for more than one LHS,
but that is rare in practical use, and the number of completed
LHS symbols in the exceptions remains low.
The very complex Perl AHFA contains 271 states with completions.
Of these 268 have only one completed symbol.
The other three AHFA states complete only two different LHS symbols.
Two states have completions with both
a \texttt{term\_hi} and an \texttt{indirob} on the LHS.
One state has completions for both a
\texttt{sideff} and an \texttt{mexpr}.

My HTML test grammars make the
same point more strongly.
My HTML parser generates grammars on the fly.
These HTML grammars can differ from each other.
because Marpa takes the HTML input into account when
generating the grammar.
In my HTML test suite,
every single one
of the 14,782 AHFA states
has only one completed LHS symbol.

\FloatBarrier

\bibliographystyle{plain}

\begin{thebibliography}{10}

\raggedright

\bibitem{AU1972}
Alfred H.~Aho and Jeffrey D.~Ullman.
\newblock The Theory of Parsing, Translation, and Computing
\newblock Prentice-Hall, Englewood Cliff, N.J., 1972.

\bibitem{AH2002}
John~Aycock and R.~Nigel~Horspool.
\newblock Practical Earley Parsing
\newblock {\em The Computer Journal},
    Vol. 45, No. 6, 2002, pp. 620-630.

\bibitem{Earley1970}
J.~Earley.
\newblock An efficient context-free parsing algorithm.
\newblock {\em Communications of the Association for Computing Machinery},
  13(2):94--102, 1970.

\bibitem{GJ2008}
Dirk~Grune and Ceriel~J.H Jacobs.
\newblock {\em Parsing Techniques: A Practical Guide}.
\newblock Springer, Amsterdam, 2008.

\bibitem{Marpa-HTML}
Jeffrey~Kegler, 2011: Marpa-HTML.
\newblock \url{http://search.cpan.org/dist/Marpa-HTML/}.

\bibitem{Marpa-R2}
Jeffrey~Kegler, 2013: Marpa-R2.
\newblock \url{http://search.cpan.org/dist/Marpa-R2/}.

\bibitem{Marpa-XS}
Jeffrey~Kegler, 2011: Marpa-XS-1.002000.
\newblock \url{http://search.cpan.org/dist/Marpa-XS/}.

\bibitem{Leo1991}
J.~M. I.~M. Leo.
\newblock A general context-free parsing algorithm running in linear time on
  every {LR($k$)} grammar without using lookahead.
\newblock {\em Theoretical Computer Science}, 82:165--176, 1991.

\end{thebibliography}

\clearpage
\tableofcontents

\end{document}
